name: Generate Metrics & Sync Output

on:
  schedule:
    - cron: "0 0 * * *"  # UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰
  workflow_dispatch:
  push:
    branches:
      - main  # ç»Ÿä¸€ä½¿ç”¨mainåˆ†æ”¯

jobs:
  generate-and-sync:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºmainåˆ†æ”¯
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # ç¬¬äºŒæ­¥ï¼šç”Ÿæˆè´¡çŒ®è´ªåƒè›‡å›¾è¡¨
      - name: Generate Snake Graphics
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            assert/github-contribution-grid-snake.svg
            assert/github-contribution-grid-snake-dark.svg?palette=github-dark
        env:
          GITHUB_TOKEN: ${{ secrets.NICK_2025 }}

      # ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆç»Ÿè®¡æŒ‡æ ‡
      - name: Generate GitHub Metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.NICK_2025 }}
          user: ${{ github.repository_owner }}
          filename: assert/github-metrics.svg
          plugins: stars,activity,repositories,followers,languages,traffic

      # ç¬¬å››æ­¥ï¼šåŒæ­¥åˆ°outputåˆ†æ”¯
      - name: Deploy to Output Branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.NICK_2025 }}
          publish_dir: ./assert
          destination_dir: .
          publish_branch: output

      # ç¬¬äº”æ­¥ï¼šæ£€å‡ºoutputåˆ†æ”¯è·å–æœ€æ–°æ–‡ä»¶
      - name: Checkout Output Branch
        uses: actions/checkout@v4
        with:
          ref: output
          path: output-branch

      # ç¬¬å…­æ­¥ï¼šåŒæ­¥æ–‡ä»¶åˆ°mainå·¥ä½œåŒº
      - name: Sync Files to Main
        run: |
          cp -rf output-branch/* assert/
          rm -rf output-branch

      # ç¬¬ä¸ƒæ­¥ï¼šæ£€æŸ¥æ–‡ä»¶å˜æ›´
      - name: Check Changes
        id: check-changes
        run: |
          git add assert/
          git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT

      # ç¬¬å…«æ­¥ï¼šæäº¤åˆ°mainåˆ†æ”¯
      - name: Commit to Main
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ Sync Output Branch Files [skip ci]"
          branch: main
          file_pattern: 
            assert/*
            README.md
          force: true
